<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Arcade Miner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- –®–†–ò–§–¢–´ --- */
        @font-face {
            font-family: 'Minecraft';
            src: url('https://cdn.jsdelivr.net/gh/South-Paw/typeface-minecraft/dist/Minecraft.woff2') format('woff2');
        }

        /* --- COLORS & VARS --- */
        :root {
            --bg-dark: #0b0b15;
            --card-bg: #151525;
            --primary: #7000ff;
            --accent: #00f0ff;
            --pink: #ff0055;
            --text-main: #ffffff;
            --text-sec: #8f90a6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 10% 20%, rgba(112, 0, 255, 0.15) 0%, transparent 40%),
                              radial-gradient(circle at 90% 80%, rgba(0, 240, 255, 0.1) 0%, transparent 40%);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* --- LAYOUT --- */
        .screen {
            flex: 1; display: none; flex-direction: column;
            width: 100%; height: 100%; overflow-y: auto;
            position: absolute; top:0; left:0; background: var(--bg-dark);
            padding-bottom: 90px;
        }
        .screen.active { display: flex; z-index: 10; }

        /* --- LOBBY STYLES --- */
        .lobby-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .user-chip { display: flex; align-items: center; gap: 10px; }
        .user-avatar-mini { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(45deg, var(--primary), var(--pink)); display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .balance-box { background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 20px; color: var(--accent); font-weight: 700; border: 1px solid rgba(255,255,255,0.1); }

        .hero-section { padding: 0 20px; margin-bottom: 25px; }
        .hero-card { height: 160px; width: 100%; background: linear-gradient(135deg, #2a0845, #6441A5); border-radius: 20px; position: relative; padding: 25px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 10px 30px rgba(112,0,255,0.2); overflow: hidden; }
        .play-btn { background: var(--accent); color: #000; padding: 10px 24px; border-radius: 30px; font-weight: 800; width: fit-content; margin-top: 10px; }
        
        .section-header { padding: 0 20px; margin-bottom: 10px; font-size: 18px; color: var(--text-sec); }
        .games-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 20px; }
        .game-tile { background: var(--card-bg); border-radius: 16px; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.05); }
        .game-tile:active { transform: scale(0.96); }

        /* --- PROFILE --- */
        .profile-header { background: linear-gradient(to bottom, #1a1a2e, var(--bg-dark)); padding: 30px 20px; display: flex; flex-direction: column; align-items: center; }
        .stat-row { display: flex; gap: 10px; width: 100%; margin-top: 20px; }
        .stat-card { flex: 1; background: var(--card-bg); padding: 15px; border-radius: 12px; text-align: center; }
        .history-item { background: var(--card-bg); margin: 0 20px 10px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; font-size: 14px; }
        .win { color: #00e676; } .loss { color: #ff3d00; }

        /* --- GAME SCREEN (MINER) --- */
        #screen-game { background-color: #87CEEB; z-index: 200; font-family: 'Minecraft', sans-serif; }
        .close-fab { position: absolute; top: 20px; left: 20px; width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; color: white; z-index: 300; cursor: pointer; }

        /* INVENTORY */
        .ui-top { padding: 10px; display: flex; justify-content: center; z-index: 20; margin-top: 60px; }
        .inventory { background: #C6C6C6; border: 4px solid #373737; padding: 4px; box-shadow: inset 4px 4px #FFF, inset -4px -4px #555; display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(3, 1fr); gap: 2px; width: 100%; max-width: 360px; }
        .slot { aspect-ratio: 1; background: #8B8B8B; border-bottom: 2px solid #FFF; border-right: 2px solid #FFF; border-top: 2px solid #373737; border-left: 2px solid #373737; display: flex; align-items: center; justify-content: center; position: relative; }
        .slot img { width: 80%; height: 80%; image-rendering: pixelated; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.5)); }

        /* FIELD */
        .game-area { flex: 1; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 80px; position: relative; width: 100%; }
        .cols-container { display: grid; grid-template-columns: repeat(5, 1fr); width: 100%; max-width: 360px; height: 100%; gap: 4px; padding: 0 6px; }
        .column { display: flex; flex-direction: column; justify-content: flex-end; position: relative; height: 100%; }
        
        /* BLOCKS & ITEMS */
        .block { width: 100%; aspect-ratio: 1; margin-bottom: 2px; position: relative; border: 2px solid rgba(0,0,0,0.2); image-rendering: pixelated; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; text-shadow: 1px 1px 0 #000; transition: transform 0.1s; }
        .b-dirt { background: #5d4037; } .b-stone { background: #757575; } .b-iron { background: #9e9e9e; } .b-gold { background: #fbc02d; } .b-diamond { background: #00bcd4; border: 2px solid #0097a7; } .b-obsidian { background: #14001c; border: 2px solid #4a148c; }
        .cracks { position: absolute; top:0; left:0; right:0; bottom:0; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.4) 10px, rgba(0,0,0,0.4) 12px); opacity: 0; pointer-events: none; }
        
        .flying-tool { position: fixed; width: 40px; height: 40px; z-index: 1000; pointer-events: none; image-rendering: pixelated; filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.3)); transition: transform 0.4s cubic-bezier(0.55, 0.055, 0.675, 0.19); }
        .chest-box { width: 100%; aspect-ratio: 1; margin-top: 4px; background: #a16b47; border: 2px solid #3e2723; display: flex; align-items: center; justify-content: center; position: relative; }
        .chest-box::after { content: ''; width: 6px; height: 8px; background: #ccc; border: 1px solid #000; }
        .chest-box.open { background: #ffd700; }

        .ground-controls { position: absolute; bottom: 0; width: 100%; height: 70px; background: #5d4037; border-top: 10px solid #589c28; display: flex; align-items: center; justify-content: center; z-index: 50; cursor: pointer; box-shadow: 0 -5px 10px rgba(0,0,0,0.3); font-family: 'Minecraft'; }
        .balance-btn { background: #373737; color: #fff; padding: 10px 40px; border: 3px solid #fff; font-size: 24px; text-shadow: 2px 2px #000; border-radius: 4px; }
        .damaged { animation: blockHit 0.1s; }
        .float-text { position: absolute; width: 100%; text-align: center; bottom: 100%; font-weight: bold; font-size: 18px; color: #FFD700; text-shadow: 2px 2px 0 #000; animation: floatText 1s forwards; pointer-events: none; z-index: 100; }
        @keyframes blockHit { 0% { transform: scale(1); filter: none; } 50% { transform: scale(0.95); filter: brightness(1.5) sepia(1) saturate(5) hue-rotate(-50deg); } 100% { transform: scale(1); filter: none; } }
        @keyframes floatText { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }

        /* --- BOTTOM NAV --- */
        .bottom-nav { position: fixed; bottom: 20px; left: 20px; right: 20px; height: 65px; background: rgba(21, 21, 37, 0.9); backdrop-filter: blur(12px); border-radius: 20px; display: flex; justify-content: space-around; align-items: center; border: 1px solid rgba(255,255,255,0.1); z-index: 100; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-sec); font-size: 10px; font-weight: 600; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }
    </style>
</head>
<body>

    <!-- LOBBY -->
    <div id="screen-lobby" class="screen active">
        <div class="lobby-header">
            <div class="user-chip">
                <div class="user-avatar-mini" id="mini-avatar">U</div>
                <div style="font-weight: bold;">User</div>
            </div>
            <div class="balance-box"><span id="lobby-balance">0</span> üíé</div>
        </div>
        
        <div class="hero-section">
            <div class="hero-card" onclick="openGame()">
                <div style="font-size: 28px; font-weight: 800;">MINER V2</div>
                <div style="color: var(--accent);">NEW MECHANIC</div>
                <div class="play-btn">PLAY</div>
                <div style="position: absolute; right: -10px; bottom: -20px; font-size: 80px;">üß®</div>
            </div>
        </div>

        <div class="section-header">Games</div>
        <div class="games-list">
            <div class="game-tile" onclick="openGame()"><div style="font-size:40px;">‚õèÔ∏è</div><div>Miner</div></div>
            <div class="game-tile" style="opacity:0.5"><div style="font-size:40px;">üé∞</div><div>Slots</div></div>
        </div>
    </div>

    <!-- PROFILE -->
    <div id="screen-profile" class="screen">
        <div class="profile-header">
            <div class="user-avatar-mini" style="width:80px; height:80px; font-size:30px; margin-bottom:10px;">U</div>
            <h2 id="profile-name">User</h2>
            <div class="stat-row">
                <div class="stat-card"><div>Games</div><div style="font-size:18px; font-weight:bold;" id="stat-games">0</div></div>
                <div class="stat-card"><div>Best Win</div><div style="font-size:18px; font-weight:bold; color:var(--accent);" id="stat-win">0</div></div>
            </div>
        </div>
        <div class="section-header" style="margin-top:20px;">History</div>
        <div id="history-list"></div>
    </div>

    <!-- GAME -->
    <div id="screen-game" class="screen">
        <div class="close-fab" onclick="navTo('lobby')">X</div>
        <div class="ui-top">
            <div class="inventory" id="slots"></div>
        </div>
        <div class="game-area">
            <div class="cols-container" id="mining-cols"></div>
        </div>
        <div class="ground-controls" onclick="spin()">
            <div class="balance-btn" id="spin-btn-text">SPIN (100)</div>
        </div>
    </div>

    <!-- NAV -->
    <div class="bottom-nav">
        <div class="nav-btn active" id="btn-lobby" onclick="navTo('lobby')"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>Lobby</div>
        <div class="nav-btn" id="btn-profile" onclick="navTo('profile')"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>Profile</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- STATE ---
        // NEW KEYS to ensure clean slate
        let balance = parseInt(localStorage.getItem('neon_v4_balance')) || 5000;
        let history = JSON.parse(localStorage.getItem('neon_v4_history')) || [];
        let stats = JSON.parse(localStorage.getItem('neon_v4_stats')) || { games: 0, win: 0 };
        
        function updateBalance(amt) {
            balance += amt;
            localStorage.setItem('neon_v4_balance', balance);
            document.getElementById('lobby-balance').innerText = balance;
        }

        // --- NAVIGATION ---
        function navTo(page) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${page}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(page === 'lobby') document.getElementById('btn-lobby').classList.add('active');
            if(page === 'profile') {
                document.getElementById('btn-profile').classList.add('active');
                renderProfile();
            }
        }
        
        function openGame() {
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–≥—Ä—ã —Ä–µ–Ω–¥–µ—Ä–∏–º –ø—É—Å—Ç—ã–µ —Å–ª–æ—Ç—ã
            createSlots();
            // –ü–æ–ª–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ (–∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ, –Ω–æ —Å–ø–∏–Ω –µ–≥–æ —Å–±—Ä–æ—Å–∏—Ç)
            document.getElementById('mining-cols').innerHTML = ''; 
        }

        function renderProfile() {
            document.getElementById('stat-games').innerText = stats.games;
            document.getElementById('stat-win').innerText = stats.win;
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            history.forEach(h => {
                list.innerHTML += `<div class="history-item"><span>${h.game}</span><span class="${h.amt>=0?'win':'loss'}">${h.amt}</span></div>`;
            });
        }

        // Init
        document.getElementById('lobby-balance').innerText = balance;
        if(tg.initDataUnsafe?.user) document.getElementById('mini-avatar').innerText = tg.initDataUnsafe.user.first_name[0];

        // ============================
        // === MINER GAME ENGINE V4 ===
        // ============================
        
        // SVGs
        const getPick = (c) => `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='${encodeURIComponent(c)}' d='M8 1h3v1h1v1h1v1h1v2h-1v-1h-1v-1h-1v-1H8v1H7v1H6v1H5v-2h1v-1h1v-1h1zm-3 4h1v1h1v1H6v1H5v-1H4v-1h1z'/><path fill='%235d4037' d='M6 6h1v1H6zM5 7h1v1H5zM4 8h1v1H4zM3 9h1v1H3zM2 10h1v1H2zM1 11h1v2h2v-1h-1v-1h-1z'/></svg>`;
        const getPearl = () => `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><circle cx='8' cy='8' r='6' fill='%2300897b'/><circle cx='6' cy='6' r='2' fill='%2380cbc4'/></svg>`;

        const TOOLS = [
            { id:'wood', dmg:1, w:50, img: getPick('#8d6e63') },
            { id:'stone', dmg:3, w:30, img: getPick('#9e9e9e') },
            { id:'iron', dmg:5, w:15, img: getPick('#fff') },
            { id:'pearl', dmg:10, w:5, img: getPearl(), bonus: true }, // –≠–Ω–¥–µ—Ä–ø–µ—Ä–ª
            { id:'empty', dmg:0, w:50, img: null }
        ];

        const BLOCKS = [
            { type: 'b-dirt', hp: 3 }, { type: 'b-stone', hp: 10 }, 
            { type: 'b-iron', hp: 20 }, { type: 'b-gold', hp: 40 }, 
            { type: 'b-diamond', hp: 80 }, { type: 'b-obsidian', hp: 150 }
        ];

        let columns = [];
        let isSpinning = false;

        function createSlots() {
            const el = document.getElementById('slots');
            el.innerHTML = '';
            for(let i=0; i<15; i++) el.innerHTML += `<div class="slot" id="slot-${i}"></div>`;
        }

        function generateField() {
            // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–æ–∫ —Å –Ω—É–ª—è (RESET)
            columns = [];
            for(let c=0; c<5; c++) {
                let stack = [];
                let count = Math.floor(Math.random() * 3) + 3; // 3-5 –±–ª–æ–∫–æ–≤
                for(let k=0; k<count; k++) {
                    let r = Math.random();
                    let b = BLOCKS[0];
                    if(r>0.5) b=BLOCKS[1]; if(r>0.7) b=BLOCKS[2]; if(r>0.85) b=BLOCKS[3]; if(r>0.95) b=BLOCKS[4];
                    stack.push({...b, max: b.hp});
                }
                columns.push(stack);
            }
            renderField();
        }

        function renderField() {
            const cont = document.getElementById('mining-cols');
            cont.innerHTML = '';
            columns.forEach((stack, c) => {
                let colDiv = document.createElement('div');
                colDiv.className = 'column';
                colDiv.id = `col-${c}`;
                
                stack.forEach((blk, idx) => {
                    let bDiv = document.createElement('div');
                    bDiv.className = `block ${blk.type}`;
                    bDiv.id = `blk-${c}-${idx}`;
                    let pct = 1 - (blk.hp/blk.max);
                    bDiv.innerHTML = `<span style="z-index:2">${blk.hp}</span><div class="cracks" style="opacity:${pct}"></div>`;
                    colDiv.appendChild(bDiv);
                });

                let chest = document.createElement('div');
                chest.className = 'chest-box'; chest.id = `chest-${c}`;
                colDiv.appendChild(chest);
                cont.appendChild(colDiv);
            });
        }

        async function spin() {
            if(isSpinning) return;
            if(balance < 100) { tg.showAlert("Need 100 üíé"); return; }

            isSpinning = true;
            updateBalance(-100);
            
            // 1. RESET FIELD (–ù–æ–≤–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞)
            generateField(); 
            tg.HapticFeedback.impactOccurred('medium');

            // 2. Roll Slots Visual
            const slots = document.querySelectorAll('.slot');
            for(let i=0; i<5; i++) {
                slots.forEach(s => s.innerText = Math.random()>0.5 ? '' : '‚ùì');
                await new Promise(r=>setTimeout(r, 50));
            }

            // 3. Generate Tools Data
            let drops = [];
            for(let i=0; i<15; i++) {
                let tool = getRandTool();
                drops.push(tool);
                let el = document.getElementById(`slot-${i}`);
                el.innerText = '';
                if(tool.img) el.innerHTML = `<img src="${tool.img}">`;
            }

            // 4. Process Drops
            await processGameLogic(drops);
            
            // Save Stats
            stats.games++;
            localStorage.setItem('neon_v4_stats', JSON.stringify(stats));
            history.unshift({game:"Miner", amt:-100}); 
            localStorage.setItem('neon_v4_history', JSON.stringify(history));

            isSpinning = false;
        }

        function getRandTool() {
            let total = TOOLS.reduce((a,b)=>a+b.w,0);
            let r = Math.random() * total;
            for(let t of TOOLS) { if(r<t.w) return t; r-=t.w; }
            return TOOLS[TOOLS.length-1];
        }

        async function processGameLogic(drops) {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            let promises = [];
            for(let c=0; c<5; c++) {
                // –ë–µ—Ä–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —ç—Ç–æ–π –∫–æ–ª–æ–Ω–∫–∏ (–∏–Ω–¥–µ–∫—Å—ã 10+c, 5+c, c)
                let colTools = [drops[10+c], drops[5+c], drops[c]]; 
                promises.push(runColumn(c, colTools));
            }
            await Promise.all(promises);
            renderField(); // Final sync
        }

        async function runColumn(c, tools) {
            // –ò–Ω–¥–µ–∫—Å—ã —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            let slotIndices = [10+c, 5+c, c];
            
            for(let i=0; i<3; i++) {
                let tool = tools[i];
                if(tool.id === 'empty') continue;

                // Animate
                await flyTool(slotIndices[i], c, tool.img);
                
                // Hit Logic
                await hitColumn(c, tool);

                // BONUS MECHANIC: –ï—Å–ª–∏ —ç—Ç–æ Pearl, –æ–Ω –≤—ã–∑—ã–≤–∞–µ—Ç –µ—â–µ –æ–¥–∏–Ω —É–¥–∞—Ä (re-spin)
                if(tool.id === 'pearl') {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ç—É–ª (–±–æ–Ω—É—Å–Ω—ã–π)
                    let bonusTool = getRandTool();
                    if(bonusTool.id !== 'empty') {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —Å–ª–æ—Ç–µ
                        let slotEl = document.getElementById(`slot-${slotIndices[i]}`);
                        slotEl.innerHTML = `<img src="${bonusTool.img}" style="filter:sepia(1) hue-rotate(90deg);">`; // Green filter for bonus
                        await new Promise(r=>setTimeout(r, 200));
                        
                        await flyTool(slotIndices[i], c, bonusTool.img);
                        await hitColumn(c, bonusTool);
                    }
                }
                
                await new Promise(r=>setTimeout(r, 100));
            }
        }

        async function flyTool(slotIdx, colIdx, imgSrc) {
            let slot = document.getElementById(`slot-${slotIdx}`);
            let target = getTarget(colIdx);
            if(!target) return;

            let img = document.createElement('img');
            img.src = imgSrc; img.className = 'flying-tool';
            let sRect = slot.getBoundingClientRect();
            let tRect = target.getBoundingClientRect();

            img.style.left = (sRect.left + sRect.width/2 - 20) + 'px';
            img.style.top = (sRect.top + sRect.height/2 - 20) + 'px';
            document.body.appendChild(img);
            slot.innerHTML = ''; // Clear slot

            // Trigger reflow
            img.getBoundingClientRect(); 

            let dx = (tRect.left + tRect.width/2) - (sRect.left + sRect.width/2);
            let dy = (tRect.top + tRect.height/2) - (sRect.top + sRect.height/2);
            
            img.style.transform = `translate(${dx}px, ${dy}px) rotate(-45deg)`;

            await new Promise(r=>setTimeout(r, 400));
            img.remove();
        }

        function getTarget(c) {
            let stack = columns[c];
            if(stack.length > 0) return document.getElementById(`blk-${c}-0`);
            return document.getElementById(`chest-${c}`);
        }

        async function hitColumn(c, tool) {
            let stack = columns[c];
            if(stack.length === 0) return; // –£–∂–µ —Å—É–Ω–¥—É–∫ –æ—Ç–∫—Ä—ã—Ç –∏–ª–∏ –ø—É—Å—Ç

            let blk = stack[0];
            let el = document.getElementById(`blk-${c}-0`);
            
            if(el) {
                el.classList.add('damaged');
                setTimeout(()=>el.classList.remove('damaged'), 100);
            }
            tg.HapticFeedback.impactOccurred('light');

            blk.hp -= tool.dmg;
            
            if(blk.hp <= 0) {
                stack.shift(); // Break block
                if(el) el.style.opacity = 0; // Visual hide
                
                // Check Chest
                if(stack.length === 0) {
                    await openChest(c);
                }
            } else {
                // Update visual HP
                if(el) {
                    el.querySelector('span').innerText = blk.hp;
                    el.querySelector('.cracks').style.opacity = 1 - (blk.hp/blk.max);
                }
            }
        }

        async function openChest(c) {
            let el = document.getElementById(`chest-${c}`);
            if(!el || el.classList.contains('open')) return;
            
            el.classList.add('open');
            let win = Math.floor(Math.random() * 300) + 50;
            
            updateBalance(win);
            if(win > stats.win) stats.win = win;

            let float = document.createElement('div');
            float.className = 'float-text'; float.innerText = `+${win}`;
            document.getElementById(`col-${c}`).appendChild(float);
            tg.HapticFeedback.notificationOccurred('success');
        }

    </script>
</body>
</html>
